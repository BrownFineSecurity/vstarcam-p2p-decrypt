#include <stdint.h>
#include <stdio.h>
#include <string.h>
#include <stdlib.h>
typedef char byte;


byte g__P2P_PE_Table[]={0x7c, 0x9c, 0xe8, 0x4a, 0x13, 0xde, 0xdc, 0xb2, 0x2f, 0x21, 0x23, 0xe4, 0x30, 0x7b, 0x3d, 0x8c, 0xbc, 0x0b, 0x27, 0x0c, 0x3c, 0xf7, 0x9a, 0xe7, 0x08, 0x71, 0x96, 0x00, 0x97, 0x85, 0xef, 0xc1, 0x1f, 0xc4, 0xdb, 0xa1, 0xc2, 0xeb, 0xd9, 0x01, 0xfa, 0xba, 0x3b, 0x05, 0xb8, 0x15, 0x87, 0x83, 0x28, 0x72, 0xd1, 0x8b, 0x5a, 0xd6, 0xda, 0x93, 0x58, 0xfe, 0xaa, 0xcc, 0x6e, 0x1b, 0xf0, 0xa3, 0x88, 0xab, 0x43, 0xc0, 0x0d, 0xb5, 0x45, 0x38, 0x4f, 0x50, 0x22, 0x66, 0x20, 0x7f, 0x07, 0x5b, 0x14, 0x98, 0x1d, 0x9b, 0xa7, 0x2a, 0xb9, 0xa8, 0xcb, 0xf1, 0xfc, 0x49, 0x47, 0x06, 0x3e, 0xb1, 0x0e, 0x04, 0x3a, 0x94, 0x5e, 0xee, 0x54, 0x11, 0x34, 0xdd, 0x4d, 0xf9, 0xec, 0xc7, 0xc9, 0xe3, 0x78, 0x1a, 0x6f, 0x70, 0x6b, 0xa4, 0xbd, 0xa9, 0x5d, 0xd5, 0xf8, 0xe5, 0xbb, 0x26, 0xaf, 0x42, 0x37, 0xd8, 0xe1, 0x02, 0x0a, 0xae, 0x5f, 0x1c, 0xc5, 0x73, 0x09, 0x4e, 0x69, 0x24, 0x90, 0x6d, 0x12, 0xb3, 0x19, 0xad, 0x74, 0x8a, 0x29, 0x40, 0xf5, 0x2d, 0xbe, 0xa5, 0x59, 0xe0, 0xf4, 0x79, 0xd2, 0x4b, 0xce, 0x89, 0x82, 0x48, 0x84, 0x25, 0xc6, 0x91, 0x2b, 0xa2, 0xfb, 0x8f, 0xe9, 0xa6, 0xb0, 0x9e, 0x3f, 0x65, 0xf6, 0x03, 0x31, 0x2e, 0xac, 0x0f, 0x95, 0x2c, 0x5c, 0xed, 0x39, 0xb7, 0x33, 0x6c, 0x56, 0x7e, 0xb4, 0xa0, 0xfd, 0x7a, 0x81, 0x53, 0x51, 0x86, 0x8d, 0x9f, 0x77, 0xff, 0x6a, 0x80, 0xdf, 0xe2, 0xbf, 0x10, 0xd7, 0x75, 0x64, 0x57, 0x76, 0xf3, 0x55, 0xcd, 0xd0, 0xc8, 0x18, 0xe6, 0x36, 0x41, 0x62, 0xcf, 0x99, 0xf2, 0x32, 0x4c, 0x67, 0x60, 0x61, 0x92, 0xca, 0xd3, 0xea, 0x63, 0x7d, 0x16, 0xb6, 0x8e, 0xd4, 0x68, 0x35, 0xc3, 0x52, 0x9d, 0x46, 0x44, 0x1e, 0x17};

byte __P2P_Proprietary_SelectTableElement(uint8_t* c_key, byte data){
    return g__P2P_PE_Table[((data & 0xff) + c_key[data & 3]) & 0xff];
}

void cs2p2p__P2P_Proprietary_Decrypt(char* key, byte* input, byte* output, uint16_t len){
    if (!key || key[0] == 0x00) {
        memcpy(output,input, len);
        return;
    }
    
    //treating it as 4 byte array insead of a u32 eliminates a shit ton of bitwise opeations,
    //so I'm pretty sure this was the case in the original source code as well
    uint8_t c_key[4]={0,0,0,0};
    //for (uint32_t i=0; i < strlen(key) && i < 21; ++i) {
    //    c_key[0] += key[i];
    //    c_key[1] -= key[i];
    //    c_key[2] += key[i] / 3;
    //    c_key[3] ^= key[i];
    //}

    for (int key = 0; key < 4; key++)
    {
        uint8_t best_key = 0;
        int best_key_count = 0;

        for (uint16_t kval = 0; kval < 256; kval++)
        {
            c_key[key] = kval;
            
            int printable_count = 0;
            for(uint16_t i=0; i<len; ++i)
            {
                output[i] = input[i] ^ __P2P_Proprietary_SelectTableElement(c_key, i==0 ? 0 : input[i-1]);
                if (output[i] >= 32 && output[i] <= 126)
                {
                    printable_count++;
                }
            }
            if (printable_count > best_key_count)
            {
                best_key = kval;
                best_key_count = printable_count;
            }
            printf("kval :%d\n",kval);
            for (int s = 0; s < printable_count; s += 10)
            {
                printf("*");
            }
            printf("\n");
        }
        c_key[key] = best_key;
    }
    printf("k0: %d\n",c_key[0]);
    printf("k1: %d\n",c_key[1]);
    printf("k2: %d\n",c_key[2]);
    printf("k3: %d\n",c_key[3]);
}

int main()
{
    char *encrypted = "\xe4\xdb\x32\xa9\x6a\x86\xf2\x9b\xcf\xdd\xb1\x6a\xe7\xce\x83\x08\xa4\xe5\xdf\xec\x1d\x9e\x2a\x6e\xcf\xec\x7c\x9b\xb8\xae\xfe\x91\x3f\x35\x5f\x0b\x51\xa7\x9b\xbd\x7b\x8e\xbd\x2f\xf8\xdb\x18\x85\xe5\x9c\x7d\x24\xba\x3b\x4e\xac\x21\xd7\xa2\x6a\xe9\x39\x5d\x77\xc6\x65\x65\x7a\xbc\x09\x18\x97\xcf\xda\xc6\x77\xce\xf1\x94\x02\xfb\x9f\xb9\x58\x99\xde\x91\x6a\xb6\xd7\xe1\xc0\xaa\xdf\x94\x66\x0c\x9f\xf6\x88\x62\x12\x19\x00\x66\x47\x25\x62\x37\xb6\xae\xcf\x96\x25\x17\xd4\x91\x54\xae\xed\x41\x1c\x34\x61\x2c\x98\xc3\x34\x6d\xec\x4c\xf7\x48\xf7\x4a\xec\x43\x15\x07\x0a\xc0\xa0\xd5\x91\x0c\xa8\x40\xe5\x97\xf9\x87\xe6\x59\xca\x25\x46\x5c\x00\x4a\xd4\xf9\xff\xe1\xd4\xad\x07\x13\xa7\xdc\x11\x4c\xe4\x3c\xee\x75\x7e\xea\x5d\x25\x3f\x33\xcb\xad\x17\x8b\x77\xdc\x44\x74\x2a\x2c\x9d\x1d\xd7\xe0\x40\xca\x0f\xec\x10\x69\x4e\xc9\x2a\x2a\x2b\xbf\x9c\x31\x7f\x3a\x98\x91\x65\x55\xf0\xf3\x33\xd8\xfe\xd5\xa3\x5d\x41\x5f\x31\x67\xb0\xbd\x77\x92\x26\x27\x8a\x6a\xf0\xe4\x79\x00\x60\x54\xb6\x97\xab\x4c\xa1\x0a\x8d\x7b\x92\x2b\xe1\xcd\xdf\x93\xc8\xef\xa6\x92\x7b\x80\xec\x4c\xf7\x29\x76\x4f\x8a\x01\x85\xf9\xe9\x66\x4f\x81\x9d\x4e\x90\xd7\xe9\x6a\xa4\xbb\x5b\x30\x70\x81\xd5\xe6\x4f\xd0\x22\x6b\x02\xf5\xe2\xfd\x48\x93\x8e\xe9\x6f\xdc\x1b\xe9\x38\xd4\xa9\x83\x33\x9c\x65\x62\x47\x31\x31\x28\x27\x8d\x78\x29\x34\x24\xfc\xd4\xef\x8b\x6a\xf2\xfa\x3d\xc9\x2a\x73\xc8\xb5\xc8\x84\xe8\x96\x1a\xc5\x9c\x3d\xc8\xeb\x0f\xf4\xa1\x1f\xe4\x3a\x9e\x1a\xef\xa2\x2b\xa3\x0b\x42\xf1\xc0\xf7\x6c\x43\x55\x93\xd8\xb7\x04\x40\xfc\xb7\x33\xdc\x40\xb5\xe5\xcd\xbe\xa0\xed\x5e\xe8\x84\xea\x07\x49\xe2\xb3\xa8\x20\x44\x17\xe5\xda\xad\x45\x28\x5a\x1e\x32\xde\xd7\xb1\x7e\xbd\x61\x67\xf8\xd0\x49\x9d\x0e\x82\x33\x8a\x13\xf2\xe8\x83\x68\xfe\xc4\x10\x26\x2c\xca\x08\xdc\x57\x5f\x26\x3c\xaf\x54\xbb\x39\x42\xed\x6c\x5e\xd3\x29\x35\x5b\x5b\x4e\xd3\x05\x59\x88\x38\xe3\x6d\xfe\xd0\x36\x60\x57\x5a\x58\xc1\x00\x74\x27\xba\x30\x3d\xb1\x00\x63\x2c\x83\x29\x35\x4b\x7b\x93\xdb\x53\xc1\x44\x21\xbb\x5c\x05\x05\x16\x89\x34\x60\x48\xc1\x02\xf1\xd8\xe3\x57\x05\x69\x64\xc5\x94\x1e\x62\x0e\x94\x08\x89\x24\xf0\xe4\x65\x3f\x20\x20\x0d\x7d\x75\x23\x4f\xd0\x29\x23\x06\x20\x44\x17\xe5\xda\xad\x45\x28\x43\x51\x81\xcf\xb6\x95\x53\x99\xd1\xb3\xae\x81\xad\x41\x5d\x5a\x0c\x9c\x32\xd9\x8f\x4c\xa7\x90\xbf\x9c\x27\xe2\xfd\x5b\x0a\xc9\x62\x73\xf2\xed\x52\x17\xcf\xbf\x9c\x21\xd2\xfc\xdb\x44\x7f\x0b\x42\xfa\x3d\xfa\x3c\xb3\xf6\x95\x07\x05\x51\xf9\x80\x85\xbd\x73\x8a\x40\xaf\x50\x50\x43\x75\x26\x7a\x9a\xa0\xae\xb7\x34\x0e\x95\x55\x88\x23\x53\x9d\x0e\x86\xbf\x94\x0f\xa7\xd8\xe5\xa1\x61\x2c\x90\x9f\xa4\xc5\x96\x00\x7a\xb0\xac\x39\x53\x99\x80\xe3\x06\x65\x31\x7c\xff\x8a\x05\x16\x94\x5c\x48\xa9\xb1\x7c\xf0\xf7\x3e\x11\x03\x55\x9f\xcc\xac\x25\x5b\x07\x0d\x23\x36\x4a\xd4\xfd\x18\x95\x5c\x12\x06\x74\x06\x7e\xbc\x23\x49\xaa\xd4\xa7\xe4\x01\xc9\x38\x9c\x73\x8b\x6c\x5d\x58\xc1\x06\x65\x07\x4b\x68\xe3\x03\x1e\x73\xc3\x5c\x79\x56\x4f\xcb\xff\xae\xe9\x3d\xd0\x20\x1a\x93\xd7\xb3\xf0\xec\x15\x0f\xb8\x8d\x4a\x92\x24\xaa\xd3\x4e\x95\x07\x77\xe5\xe5\xf9\xaf\x0a\xf4\xce\xf5\xe0\x09\x75\x39\x45\x61\x3e\x2b\xb4\x95\x41\x50\x52\x58\x9f\xbf\xf0\x8f\x5f\x35\x5d\x08\xa1\x02\xf2\xf2\xc4\x00\x7d\x75\x21\xd1\xe7\x95\x46\x40\xa6\xde\xd7\xb9\x04\x17\xd2\xba\x3b\x4e\xac\x21\xd7\xa2\x6a\xf5\xf4\xb4\x96\x07\x4f\xcd\x8d\x62\x1b\xbf\xa2\x22\x6b\x0b\x43\x47\x69\x31\x7e\xa7\x8d\x6b\x52\x54\xe3\x6a\x8c\x79\x41\x4e\x86\x81\xd2\xfb\x98\xcf\xa5\x29\x19\x0d\x79\x42\xec\x1d\xb5\xb2\x65\x2c\x99\x83\x7c\xe5\xf3\x1b\x9f\xb9\x58\x95\x39\x3a\xd3\x17\x9d\x58\xdd\xc5\x85\xbb\x39\x42\xfd\x35\x59\xcd\xbb\x32\xf2\xeb\x0f\xff\xba\x69\x16\x94\x4e\xf0\xc1\x56\x15\x3f\x4f\xcf\xb6\x95\x14\xef\xa1\x0a\x95\x75\x3a\xd1\xea\x03\x4d\x6b\x06\x72\x83\x7d\x7d\x7b\x8f\x14\x9a\xa6\xbf\xf7\x68\xeb\x0f\xba\x72\x8d\x61\x2e\x2c\x95\x59\xd1\xec\x4c\xe4\x30\x0b\x2d\x0a\x98\xd2\xab\x4c\xa0\xef\xa4\xef\xa6\xc6\x5e\xe7\xa6\xd3\x1f\xb7\x4d\x7a\x8b\x6d\xd7\x80\xf8\x8f\x14\x9b\xf5\x8c\x05\x12\x11\x10\x3b\x37\x99\x81\xc2\xd1\xee\x3a\xcb\x80\xf9\xe8\x85\xf6\x98\x9b\xc3\x5b\x4c\xb4\x94\x4c\xb6\x92\x64\xc1\x11\x0c\x8a\x3f\x30\x75\x2a\x3c\xae\xb1\x3b\x78\x45\x02\xe2\xa1\x19\x41\x51\xa3\x53\xa3\x58\xdb\x46\x55\x95\x46\x51\x9d\x0d\x6b\x0a\x8b\x6a\xbb";
    int len = 1032;
    char *decrypted = malloc(len);
    cs2p2p__P2P_Proprietary_Decrypt("doesntmatter",encrypted,decrypted,len);
    return 0;
}
